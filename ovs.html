<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>ovs | The handbook to collect commands, usages and thoughts</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="./ovs_flow.html" />
    
    
    <link rel="prev" href="./bash.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="11"
        data-chapter-title="ovs"
        data-filepath="ovs.md"
        data-basepath="."
        data-revision="Sat Feb 06 2016 12:53:35 GMT+0800 (中国标准时间)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> Software manager</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="yum.html">
            
                
                    <a href="./yum.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        yum
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="apt-get.html">
            
                
                    <a href="./apt-get.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        apt-get
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="find-grep.html">
            
                
                    <a href="./find-grep.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        find-grep
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="linuxtool.html">
            
                
                    <a href="./linuxtool.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Linux tools
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="linuxsystem.html">
            
                
                    <a href="./linuxsystem.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Linux system configuration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="ubuntutips.html">
            
                
                    <a href="./ubuntutips.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        ubuntu tips
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="doscommands.html">
            
                
                    <a href="./doscommands.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        DOS commands
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="gcctips.html">
            
                
                    <a href="./gcctips.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        gcc
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="network.html">
            
                
                    <a href="./network.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        network
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="tcpdump.html">
            
                
                    <a href="./tcpdump.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        tcpdump
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="bash.html">
            
                
                    <a href="./bash.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        bash
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="11" data-path="ovs.html">
            
                
                    <a href="./ovs.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        ovs
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="ovs_flow.html">
            
                
                    <a href="./ovs_flow.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        ovs flow
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="sr-iov.html">
            
                
                    <a href="./sr-iov.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        sr-iov
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="dpdk.html">
            
                
                    <a href="./dpdk.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        dpdk
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="gitbook.html">
            
                
                    <a href="./gitbook.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        gitbook
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="git.html">
            
                
                    <a href="./git.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        git
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="openstackusage.html">
            
                
                    <a href="./openstackusage.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        openstack usage
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="virsh.html">
            
                
                    <a href="./virsh.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        virsh
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="pdb.html">
            
                
                    <a href="./pdb.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        pdb
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="mysql.html">
            
                
                    <a href="./mysql.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        mysql
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="oracle.html">
            
                
                    <a href="./oracle.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        oracle
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="sybase.html">
            
                
                    <a href="./sybase.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        sybase
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="pythontools.html">
            
                
                    <a href="./pythontools.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        python tools
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >The handbook to collect commands, usages and thoughts</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="ovs-components-and-commands">OVS components and commands</h1>
<h1 id="build-and-compile">build and compile</h1>
<h2 id="compile-form-source-code">Compile form source code</h2>
<p>Kerenel version support from 2.6.32 - 3.14(read the FAQ)</p>
<pre><code>./boot.sh
./configure --prefix=/usr --with-linux=/lib/modules/`uname -r`/build
make
make modules_install
make install
modprobe openvswitch
</code></pre><p>(Has issues, configure hang when write to db; and port cannot be seen with ip link)<br>(to verify <a href="http://blog.onos.top/linux/2015/01/06/install-openvswitch-on-ubuntu14.04lts/" target="_blank">http://blog.onos.top/linux/2015/01/06/install-openvswitch-on-ubuntu14.04lts/</a> )</p>
<h2 id="build-deb-package">Build deb package</h2>
<p>(<a href="http://www.docoreos.com/?p=79" target="_blank">http://www.docoreos.com/?p=79</a> )<br>&#x68C0;&#x67E5;&#x4E0B;&#x662F;&#x5426;&#x4F9D;&#x8D56;&#x5305;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;<code>dpkg-checkbuilddeps</code><br>&#x6784;&#x5EFA;&#x5B89;&#x88C5;&#x5305;</p>
<pre><code>DEB_BUILD_OPTIONS=&apos;parallel=8 nocheck&apos; 
fakeroot debian/rules binary
dpkg -i openvswitch-common_2.3.2-1_amd64.deb  openvswitch-switch_2.3.2-1_amd64.deb
</code></pre><h2 id="build-rpm-package">Build rpm package</h2>
<p>(<a href="https://pario.no/2015/05/26/installing-open-vswitch-on-centos-7/&#xFF09;" target="_blank">https://pario.no/2015/05/26/installing-open-vswitch-on-centos-7/&#xFF09;</a></p>
<pre><code>yum groupinstall &quot;Development Tools&quot;
mkdir -p ~/rpmbuild/SOURCES
cd ~/rpmbuild/SOURCES
wget http://openvswitch.org/releases/openvswitch-2.3.1.tar.gz
tar xfz openvswitch-2.3.1.tar.gz
sed &apos;s/openvswitch-kmod, //g&apos; openvswitch-2.3.1/rhel/openvswitch.spec &gt; openvswitch-2.3.1/rhel/openvswitch_no_kmod.spec
rpmbuild -bb --nocheck ~/openvswitch-2.3.1/rhel/openvswitch_no_kmod.spec
yum localinstall /home/ovswitch/rpmbuild/RPMS/x86_64/openvswitch-2.3.1-1.x86_64.rpm
</code></pre><h1 id="ovs-components">OVS components</h1>
<h2 id="ovsvswitchd">ovs-vswitchd</h2>
<p>Core component in the system</p>
<ul>
<li>Communicates with outside world using OpenFlow</li>
<li>Communicates with ovsdb-server using management protocol</li>
<li>Communicates with kernel module over netlink</li>
<li>Communicates with the system through netdev abstract interface</li>
</ul>
<p>Supports multiple independent datapaths (bridges)<br>Packet classifier supports efficient flow lookup with wildcards and &#x201C;explodes&#x201D; these (possibly) wildcard rules for fast processing by the datapath<br>Implements mirroring, bonding, and VLANs through modifications of the same flow table exposed through OpenFlow<br>Check datapath flow counters to handle flow expiration and stats request  </p>
<h2 id="openvswitchmodko">openvswitch_mod.ko</h2>
<p>Kernel module that handles switching and tunneling</p>
<ul>
<li>Exact-match cache of flows</li>
<li>Designed to be fast and simple</li>
<li>Packet comes in, if found, associated actions executed and counters updated. Otherwise, sent to userspace</li>
<li>Does no flow expiration</li>
<li>Knows nothing of OpenFlow</li>
<li>Implements tunnels</li>
</ul>
<h2 id="commands">commands</h2>
<ul>
<li>ovs-appctl&#x53D1;&#x9001;&#x547D;&#x4EE4;&#x6D88;&#x606F;&#xFF0C;&#x8FD0;&#x884C;&#x76F8;&#x5173;daemon</li>
<li>ovs-vswitchd &#x5B88;&#x62A4;&#x7A0B;&#x5E8F;&#xFF0C;&#x5B9E;&#x73B0;&#x4EA4;&#x6362;&#x529F;&#x80FD;&#xFF0C;&#x548C;Linux&#x5185;&#x6838;&#x6A21;&#x5757;&#x4E00;&#x8D77;&#xFF0C;&#x5B9E;&#x73B0;&#x57FA;&#x4E8E;&#x6D41;&#x7684;&#x4EA4;&#x6362;flow-based switching&#x3002;</li>
<li>ovsdb-server&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x6570;&#x636E;&#x5E93;&#x670D;&#x52A1;&#xFF0C;&#x4FDD;&#x5B58;OVS&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</li>
<li>ovsdb-tool</li>
<li>ovsdb-client</li>
<li>ovs-l3ping</li>
<li>ovs-vlan-test</li>
<li>ovs-benchmark</li>
<li>ovs-vsctl&#x83B7;&#x53D6;&#x6216;&#x8005;&#x66F4;&#x6539;ovs-vswitchd&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x6B64;&#x5DE5;&#x5177;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x66F4;&#x65B0;ovsdb-server&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5E93;</li>
<li>ovs-bugtool</li>
<li>ovs-dpctl &#x914D;&#x7F6E;&#x4EA4;&#x6362;&#x673A;&#x5185;&#x6838;&#x6A21;&#x5757;</li>
<li>ovs-dpctl-top</li>
<li>ovs-parse-backtrace</li>
<li>ovs-test</li>
<li>ovs-pcap</li>
<li>ovs-vlan-bug-workaround </li>
<li>ovs-appctl&#x53D1;&#x9001;&#x547D;&#x4EE4;&#x6D88;&#x606F;&#xFF0C;&#x8FD0;&#x884C;&#x76F8;&#x5173;daemon</li>
<li>ovs-vswitchd &#x5B88;&#x62A4;&#x7A0B;&#x5E8F;&#xFF0C;&#x5B9E;&#x73B0;&#x4EA4;&#x6362;&#x529F;&#x80FD;&#xFF0C;&#x548C;Linux&#x5185;&#x6838;&#x6A21;&#x5757;&#x4E00;&#x8D77;&#xFF0C;&#x5B9E;&#x73B0;&#x57FA;&#x4E8E;&#x6D41;&#x7684;&#x4EA4;&#x6362;flow-based switching&#x3002;</li>
<li>ovsdb-server&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x6570;&#x636E;&#x5E93;&#x670D;&#x52A1;&#xFF0C;&#x4FDD;&#x5B58;OVS&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</li>
<li>ovsdb-tool</li>
<li>ovsdb-client</li>
<li>ovs-l3ping</li>
<li>ovs-vlan-test</li>
<li>ovs-benchmark</li>
<li>ovs-vsctl&#x83B7;&#x53D6;&#x6216;&#x8005;&#x66F4;&#x6539;ovs-vswitchd&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x6B64;&#x5DE5;&#x5177;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x66F4;&#x65B0;ovsdb-server&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5E93;</li>
<li>ovs-bugtool</li>
<li>ovs-dpctl &#x914D;&#x7F6E;&#x4EA4;&#x6362;&#x673A;&#x5185;&#x6838;&#x6A21;&#x5757;</li>
<li>ovs-dpctl-top</li>
<li>ovs-parse-backtrace</li>
<li>ovs-test</li>
<li>ovs-pcap</li>
<li>ovs-vlan-bug-workaround </li>
</ul>
<h1 id="system">system</h1>
<h2 id="set-the-number-of-handlerrevalidator-threads">set the number of handler/revalidator threads</h2>
<pre><code>ovs-vsctl --no-wait set Open_vSwitch . other_config:n-handler-threads=12
</code></pre><p>Specifies the number of threads for software datapaths to use for handling new flows. The default the number of online CPU cores minus the number of revalidators.
This configuration is per datapath.  If you have more than one software datapath (e.g. some system bridges and some Netdev bridges), then the total number of threads is n-handler-threads times the number of software datapaths.</p>
<pre><code>ovs-vsctl --no-wait set Open_vSwitch . other_config:n-revalidator-threads=8
</code></pre><p>Specifies the number of threads for software datapaths to use for revalidating flows in the datapath.  Typically, there is a direct  correlation between the number of revalidator threads, and the number of flows allowed in the datapath.  The default is the number of cpu cores divided by four plus one.  If n-handler-threads is set, the default  changes to the number of cpu cores minus the number of handler threads.</p>
<p>This configuration is per datapath.  If you have more than one software datapath (e.g. some system bridges and some netdev bridges), then the total number of threads is n-handler-threads times the number of software datapaths.</p>
<h1 id="port">port</h1>
<h2 id="dump-port-statistics">dump port statistics</h2>
<pre><code>[root@kvmnode002108 ~]# ovs-ofctl dump-ports br-bond1  
OFPST_PORT reply (xid=0x2): 3 ports
  port  8: rx pkts=173661128, bytes=26733568116, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=2011912554, bytes=448454625257, drop=0, errs=0, coll=0
  port LOCAL: rx pkts=6, bytes=468, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=2030080686, bytes=334610413022, drop=9877323096, errs=0, coll=0
  port  1: rx pkts=20991153020, bytes=3026825890957, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=1320548559, bytes=468321506901, drop=0, errs=0, coll=0
</code></pre><p>or</p>
<pre><code>[root@dog neutron]# ovs-vsctl get interface eth1 statistics
{collisions=0, rx_bytes=14449413, rx_crc_err=0, rx_dropped=0, rx_errors=0, rx_frame_err=0, rx_over_err=0, rx_packets=57270, tx_bytes=601444, tx_dropped=0, tx_errors=0, tx_packets=9320}
</code></pre><h2 id="checkchange-tx-queue">check/change tx queue</h2>
<p>Check tx queue length</p>
<pre><code>[root@fish ~]# ip link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 6c:92:bf:07:14:99 brd ff:ff:ff:ff:ff:ff
</code></pre><p>or</p>
<pre><code>[root@fish ~]# cat /sys/class/net/qvbcbf85285-5d/tx_queue_len                       
1000
</code></pre><p>change tx queue length</p>
<pre><code>[root@fish ~]# echo 1000 &gt; /sys/class/net/qvbcbf85285-5d/tx_queue_len 
[root@fish ~]# ifconfig qvbcbf85285-5d                                
qvbcbf85285-5d Link encap:Ethernet  HWaddr D2:87:EA:A7:7E:7F  
          inet6 addr: fe80::d087:eaff:fea7:7e7f/64 Scope:Link
          UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1500  Metric:1
          RX packets:6 errors:0 dropped:0 overruns:0 frame:0
          TX packets:9 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:468 (468.0 b)  TX bytes:678 (678.0 b)
</code></pre><p>or</p>
<pre><code>[root@fish ~]# ip link set txqueuelen 1000 dev qvbcbf85285-5d
</code></pre><h2 id="bond-port">bond port</h2>
<p><a href="http://blog.scottlowe.org/2012/10/19/link-aggregation-and-lacp-with-open-vswitch/" target="_blank">http://blog.scottlowe.org/2012/10/19/link-aggregation-and-lacp-with-open-vswitch/</a></p>
<pre><code>ovs-vsctl add-bond ovsbr1 bond0 eth1 eth3 lacp=active
ovs-appctl bond/show &lt;bond name&gt;
ovs-appctl lacp/show &lt;bond name&gt;
</code></pre><p>Check bond port</p>
<pre><code>ovs-appctl bond/show
</code></pre><p>set the bond mode to <a href="http://openvswitch.org/pipermail/dev/2011-July/010028.html" target="_blank">balance-slb</a></p>
<pre><code>ovs-vsctl set port bond0 bond_mode=balance-slb
</code></pre><blockquote>
<p>SLB bonding allows a limited form of load balancing without the remote switch&apos;s knowledge or cooperation.  The basics of SLB are simple.  SLB assigns each source MAC+VLAN pair to a link and transmits all packets  from that MAC+VLAN through that link.  Learning in the remote switch causes it to send packets to that MAC+VLAN through the same link.</p>
</blockquote>
<h2 id="patch-port">patch port</h2>
<pre><code>ovs-vsctl add-port br-ex patch-int
ovs-vsctl set interface patch-int type=patch
ovs-vsctl set interface &lt;port name&gt; options:peer=&lt;peer name&gt;
</code></pre><h2 id="vlan">vlan</h2>
<pre><code>ovs-vsctl set port eth0 vlan_mode=native-untagged trunks=0,11,33,44,55,66,99
</code></pre><p>native-untagged: accept both tagged and untagged packet  </p>
<p>clean port trunk</p>
<pre><code>ovs-vsctl clear port eth0 trunks
ovs-vsctl set port eth0 trunks=[]
</code></pre><h2 id="fdb">fdb</h2>
<p>show fdb table</p>
<pre><code>[root@dog ~]# ovs-appctl fdb/show br-eth1
 port  VLAN  MAC                Age
    4  1500  90:e2:ba:68:e1:d0  202
    8  1100  fa:16:3e:00:5a:a0  146
    8  1100  fa:16:3e:c8:7a:34  122
    8  1100  fa:16:3e:8b:0c:2b   77
    4  1100  90:e2:ba:68:e1:d0   61
    8  1100  fa:16:3e:70:9c:27   11
    8  1100  fa:16:3e:64:7f:91    1
</code></pre><p>flush fdb table</p>
<pre><code>[root@dog ~]# ovs-appctl fdb/flush br-eth1
table successfully flushed
</code></pre><h2 id="set-mac-aging-time">set MAC aging time</h2>
<p>The maximum number of seconds to retain a MAC learning entry for which no packets have been seen.  The default is currently 300 seconds (5 minutes).  The value, if specified, is forced into a reasonable range, currently 15 to 3600 seconds</p>
<pre><code>ovs-vsctl --no-wait set bridge br-eth1  other_config:mac-aging-time=100
</code></pre><h2 id="set-mac-table-size">set MAC table size</h2>
<p>The maximum number of MAC addresses to learn.  The default is currently 2048.  The value, if specified, is forced into a reasonable range, currently 10 to 1,000,000.</p>
<pre><code>ovs-vsctl --no-wait set bridge br-eth1  other_config:mac-table-size=100
</code></pre><h2 id="list-bridge">list bridge</h2>
<pre><code>[root@kvmnode002108 ~]# ovs-vsctl list-br
br-bond1
br-ha
br-int
</code></pre><h1 id="flow">Flow</h1>
<p>Open vSwitch uses different kinds of flows for different purposes:</p>
<ul>
<li><p>OpenFlow flows are the most important kind of flow. OpenFlow controllers use these flows to define a switch&apos;s policy. OpenFlow flows support wildcards, priorities, and multiple tables.<br>When in-band control is in use, Open vSwitch sets up a few &quot;hidden&quot; flows, with priority higher than a controller or the user can configure, that are not visible via OpenFlow. (See the &quot;Controller&quot; section of the FAQ for more information about hidden flows.)</p>
</li>
<li><p>The Open vSwitch software switch implementation uses a second kind of flow internally. These flows, called &quot;datapath&quot; or &quot;kernel&quot; flows, do not support priorities and comprise only a single table, which makes them suitable for caching. (Like OpenFlow flows, datapath flows do support wildcarding, in Open vSwitch 1.11 and later.) OpenFlow flows and datapath flows also support different actions and number ports differently.<br>Datapath flows are an implementation detail that is subject to change in future versions of Open vSwitch. Even with the current version of Open vSwitch, hardware switch implementations do not necessarily use this architecture.</p>
</li>
</ul>
<p>Users and controllers directly control only the OpenFlow flow table. Open vSwitch manages the datapath flow table itself, so users should not normally be concerned with it.</p>
<h2 id="show-flows">show flows</h2>
<p>Show all/hide flows</p>
<pre><code>ovs-appctl bridge/dump-flows br-int
</code></pre><p>Show particular userpsace bridge datapath flows</p>
<pre><code>ovs-appctl dpif/dump-flows &lt;br&gt;
</code></pre><p>Show all userspace bridges datapath flows</p>
<pre><code>ovs-dpctl dump-flows
ovs-appctl dpif/show
</code></pre><p>Show datapath flow like <code>top</code>, get which port have biggest traffic.</p>
<pre><code>ovs-dpctl-top
</code></pre><p>Show the name of each configured datapath</p>
<pre><code>ovs-appctl dpif/dump-dps
system@br-bond1
system@br-int
</code></pre><p>Check flow limit/status</p>
<pre><code>ovs-appctl upcall/show
system@ovs-system:
 flows         : (current 2) (avg 164) (max 16622) (limit 200000)
 dump duration : 2ms
</code></pre><h2 id="set-flow-limit">set flow limit</h2>
<p>This command is only needed for advanced debugging. Max 200000, min 1000</p>
<pre><code>ovs-appctl upcall/set-flow-limit 200000
</code></pre><h2 id="megaflows">megaflows</h2>
<p>Enable/disable megaflows</p>
<pre><code>ovs-appctl upcall/enable-megaflows
ovs-appctl upcall/disable-megaflows
</code></pre><p>Check whether megaflows is enabled or not. The only way I know to check is by checking if the datapath flows include PORT parameters.</p>
<pre><code>ovs-dpctl dump-flows|grep -E &quot;udp|tcp&quot;
</code></pre><h2 id="flow-in-datapath">flow in datapath</h2>
<p>Check flow hit/missed/lost</p>
<pre><code>[root@dog ~]# ovs-dpctl show 
system@ovs-system:
        lookups: hit:14198854105 missed:1242464087 lost:1114150373
        flows: 1
        masks: hit:17458094925 total:3 hit/pkt:1.13
</code></pre><p>The  &quot;lookups&quot;  row  displays three stats related to flow lookup triggered by processing incoming packets in the datapath.  &quot;hit&quot; displays number of packets matches existing flows. &quot;missed&quot; displays the number of packets not matching any existing  flow  and require  user space processing.  &quot;lost&quot; displays number of packets destined for user space  process  but  subsequently  dropped before reaching userspace. The sum of &quot;hit&quot; and &quot;miss&quot; equals to the total number of packets datapath processed.</p>
<p>More about the &quot;lost&quot;<br><a href="http://openvswitch.org/pipermail/dev/2014-April/039213.html" target="_blank">http://openvswitch.org/pipermail/dev/2014-April/039213.html</a>
Packets are being sent to userspace faster than they can be processed. This is usually because the packets have varying headers (e.g., a port scan) that cause misses in the exact-match flow cache in the kernel.</p>
<p>The &quot;masks&quot; row displays the mega flow mask stats. This  row  is omitted  for datapath not implementing mega flow. &quot;hit&quot; displays the total number of masks visited for matching incoming packets. &quot;total&quot; displays number of masks in the datapath. &quot;hit/pkt&quot; displays the average number of masks visited per packet; the ratio between &quot;hit&quot; and total number of packets processed by the datapath&quot;.</p>
<p>flow used:never  </p>
<p>It means that a packet has never matched that flow in the datapath. The packet that generated the flow was handled by ovs-vswitchd, so it&apos;s not accounted for in the datapath flow table.</p>
<p>Prints a summary of configured datapaths, including statistics and a list of connected ports. The port  information includes the OpenFlow port number, datapath port number, and the type.</p>
<pre><code>ovs-appctl dpif/show
</code></pre><h2 id="trace-flow">trace flow</h2>
<pre><code>ovs-appctl ofproto/trace &lt;flow&gt;
</code></pre><h1 id="database">Database</h1>
<h2 id="list-database">List database</h2>
<pre><code>[root@dog ~]# ovsdb-client list-dbs
Open_vSwitch
</code></pre><h2 id="list-tables">List tables</h2>
<pre><code>[root@dog ~]# ovsdb-client dump | grep table
Bridge table
Controller table
Flow_Sample_Collector_Set table
Flow_Table table
IPFIX table
Interface table
Manager table
Mirror table
NetFlow table
Open_vSwitch table
Port table
QoS table
Queue table
SSL table
sFlow table
</code></pre><pre><code>[root@dog ~]# ovsdb-client list-tables
Table                    
-------------------------
Port                     
Manager                  
Bridge                   
Interface                
SSL                      
IPFIX                    
Open_vSwitch             
Queue                    
NetFlow                  
Mirror                   
QoS                      
Controller               
Flow_Table               
sFlow                    
Flow_Sample_Collector_Set
</code></pre><pre><code>[root@dog ~]# ovsdb-client list-columns Port
Column            Type                                                                                                 
----------------- -----------------------------------------------------------------------------------------------------
name              &quot;string&quot;                                                                                             
statistics        {&quot;key&quot;:&quot;string&quot;,&quot;max&quot;:&quot;unlimited&quot;,&quot;min&quot;:0,&quot;value&quot;:&quot;integer&quot;}                                         
vlan_mode         {&quot;key&quot;:{&quot;enum&quot;:[&quot;set&quot;,[&quot;access&quot;,&quot;native-tagged&quot;,&quot;native-untagged&quot;,&quot;trunk&quot;]],&quot;type&quot;:&quot;string&quot;},&quot;min&quot;:0}
qos               {&quot;key&quot;:{&quot;refTable&quot;:&quot;QoS&quot;,&quot;type&quot;:&quot;uuid&quot;},&quot;min&quot;:0}                                                     
_uuid             &quot;uuid&quot;                                                                                               
trunks            {&quot;key&quot;:{&quot;maxInteger&quot;:4095,&quot;minInteger&quot;:0,&quot;type&quot;:&quot;integer&quot;},&quot;max&quot;:4096,&quot;min&quot;:0}                       
mac               {&quot;key&quot;:&quot;string&quot;,&quot;min&quot;:0}                                                                             
status            {&quot;key&quot;:&quot;string&quot;,&quot;max&quot;:&quot;unlimited&quot;,&quot;min&quot;:0,&quot;value&quot;:&quot;string&quot;}                                          
interfaces        {&quot;key&quot;:{&quot;refTable&quot;:&quot;Interface&quot;,&quot;type&quot;:&quot;uuid&quot;},&quot;max&quot;:&quot;unlimited&quot;}                                     
bond_active_slave {&quot;key&quot;:&quot;string&quot;,&quot;min&quot;:0}                                                                             
bond_downdelay    &quot;integer&quot;                                                                                            
_version          &quot;uuid&quot;                                                                                               
bond_mode         {&quot;key&quot;:{&quot;enum&quot;:[&quot;set&quot;,[&quot;active-backup&quot;,&quot;balance-slb&quot;,&quot;balance-tcp&quot;]],&quot;type&quot;:&quot;string&quot;},&quot;min&quot;:0}       
bond_updelay      &quot;integer&quot;                                                                                            
external_ids      {&quot;key&quot;:&quot;string&quot;,&quot;max&quot;:&quot;unlimited&quot;,&quot;min&quot;:0,&quot;value&quot;:&quot;string&quot;}                                          
other_config      {&quot;key&quot;:&quot;string&quot;,&quot;max&quot;:&quot;unlimited&quot;,&quot;min&quot;:0,&quot;value&quot;:&quot;string&quot;}                                          
bond_fake_iface   &quot;boolean&quot;                                                                                            
tag               {&quot;key&quot;:{&quot;maxInteger&quot;:4095,&quot;minInteger&quot;:0,&quot;type&quot;:&quot;integer&quot;},&quot;min&quot;:0}                                  
fake_bridge       &quot;boolean&quot;                                                                                            
lacp              {&quot;key&quot;:{&quot;enum&quot;:[&quot;set&quot;,[&quot;active&quot;,&quot;off&quot;,&quot;passive&quot;]],&quot;type&quot;:&quot;string&quot;},&quot;min&quot;:0}
</code></pre><h2 id="list-specific-columns-and-specific-target">List specific columns and specific target:</h2>
<pre><code>[root@dog ~]# ovs-vsctl --columns=name,other_config,tag list port tapd4b00ffc-bb
name                : &quot;tapd4b00ffc-bb&quot;
other_config        : {segmentation_id=&quot;1500&quot;}
tag                 : 3
</code></pre><p>The schema:  modify it if want to add new tables <code>/usr/local/share/openvswitch/vswitch.ovsschema</code><br>The db instance: <code>/usr/local/etc/openvswitch/conf.db</code></p>
<h2 id="&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;">&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;:</h2>
<pre><code>ovs-vsctl list/set/get/add/remove/clear/destroy table record column [value]
</code></pre><p>ovsdb-server&#x4E0E;ovs-vswitchd&#x901A;&#x8FC7; <code>/var/run/openvswitch/db.sock</code>&#x901A;&#x4FE1;&#x3002;<br>ovs-vswitchd&#x901A;&#x8FC7;&#x548C;ovsdb-server&#x4FEE;&#x6539;&#x6570;&#x636E;&#x5E93;&#xFF0C;ovs-vsctl&#x5927;&#x90E8;&#x95E8;&#x547D;&#x4EE4;&#x90FD;&#x662F;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<h2 id="&#x8FDC;&#x7A0B;&#x63A7;&#x5236;ovsdbserver">&#x8FDC;&#x7A0B;&#x63A7;&#x5236;ovsdb-server</h2>
<p>&#x8BBE;&#x7F6E;manager </p>
<pre><code>ovs-vsctl set-manager ptcp:8881
</code></pre><p>&#x5728;&#x53E6;&#x4E00;&#x53F0;server&#x4E0A;,&#x914D;&#x7F6E;&#x76EE;&#x6807;server&#x7684;db</p>
<pre><code>ovs-vsctl --db=tcp:16.158.165.153:8881
</code></pre><h1 id="sflow">sflow</h1>
<h2 id="configure-sflow">Configure sflow</h2>
<pre><code>ovs-vsctl -- --id=@sflow create sflow agent=${AGENT_IP} target=\&quot;${COLLECTOR_IP}:${COLLECTOR_PORT}\&quot; header=${HEADER_BYTES} sampling=${SAMPLING_N} polling=${POLLING_SECS} -- set bridge br-int sflow=@sflow

[root@kvmnode002108 ~]# cat .sflow 
COLLECTOR_IP=10.27.248.3
COLLECTOR_PORT=6343
AGENT_IP=127.0.0.1
HEADER_BYTES=128
SAMPLING_N=64
POLLING_SECS=10
</code></pre><h2 id="list-sflow-configuration">list sflow configuration</h2>
<pre><code>[root@dog ~]# ovs-vsctl list sflow
_uuid               : 705b5f89-4d58-4777-86d9-e44fe81271db
agent               : &quot;eth0&quot;
external_ids        : {}
header              : 128
polling             : 10
sampling            : 512
targets             : [&quot;10.24.74.73:6343&quot;]
</code></pre><h2 id="delete-sflow-configuration">delete sflow configuration</h2>
<p>Check sflow belone to which bridge</p>
<pre><code>[root@fish ~]# ovs-vsctl list bridge | grep sflow
sflow               : 20f8d4bf-e3f2-4235-bfce-b2c2689f7da8
sflow               : 3ecbe3cb-70fc-4a38-a657-e68c8acfca87
sflow               : []
</code></pre><p>Delete sflow from that bridge</p>
<pre><code>[root@dog ~]# ovs-vsctl remove bridge br-int sflow 705b5f89-4d58-4777-86d9-e44fe81271db
</code></pre><p>OR</p>
<pre><code>ovs-vsctl -- clear Bridge br-int sflow
ovs-vsctl -- clear Bridge br-bond1 sflow
</code></pre><h1 id="controller">Controller</h1>
<h2 id="fail-mode">fail mode</h2>
<p>OpenvSwitch &#x5728;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#x5230;&#x63A7;&#x5236;&#x5668;&#x65F6;&#x5019;&#xFF08;fail mode&#xFF09;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4E24;&#x79CD;fail&#x72B6;&#x6001;&#xFF0C;&#x4E00;&#x79CD;&#x662F;standalone&#xFF0C;&#x4E00;&#x79CD;&#x662F;secure&#x72B6;&#x6001;&#x3002;&#x5982;&#x679C;&#x662F;&#x914D;&#x7F6E;&#x4E86;standalone&#xFF08;&#x6216;&#x8005;&#x672A;&#x8BBE;&#x7F6E;fail mode&#xFF09;mode&#xFF0C;&#x5728;&#x4E09;&#x6B21;&#x63A2;&#x6D4B;&#x63A7;&#x5236;&#x5668;&#x8FDE;&#x63A5;&#x4E0D;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x6B64;&#x65F6;ovs-vswitchd&#x5C06;&#x4F1A;&#x63A5;&#x7BA1;&#x8F6C;&#x53D1;&#x903B;&#x8F91;&#xFF08;&#x540E;&#x53F0;&#x4ECD;&#x7136;&#x5C1D;&#x8BD5;&#x8FDE;&#x63A5;&#x5230;&#x63A7;&#x5236;&#x5668;&#xFF0C;&#x4E00;&#x65E6;&#x8FDE;&#x63A5;&#x5219;&#x9000;&#x51FA;fail&#x72B6;&#x6001;&#xFF09;&#xFF0C;OpenvSwitch&#x5C06;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;MAC-learning&#x7684;&#x4E8C;&#x5C42;&#x4EA4;&#x6362;&#x673A;&#x3002;&#x5982;&#x679C;&#x662F;&#x914D;&#x7F6E;&#x4E86;secure mode&#xFF0C;&#x5219;ovs-vswitchd&#x5C06;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x65B0;&#x7684;&#x8F6C;&#x53D1;&#x6D41;&#x8868;&#xFF0C;OpenvSwitch&#x5C06;&#x6309;&#x7167;&#x539F;&#x5148;&#x6709;&#x7684;&#x6D41;&#x8868;&#x8F6C;&#x53D1;&#x3002;  &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x7BA1;&#x7406;&#x3002;</p>
<pre><code>ovs-vsctl get-fail-mode &lt;bridge&gt;
ovs-vsctl del-fail-mode &lt;bridge&gt;
ovs-vsctl set-fail-mode &lt;bridge&gt; &lt;standalone|secure&gt;
</code></pre><h1 id="debug">debug</h1>
<h2 id="show-coverage-counters">show coverage counters</h2>
<pre><code>[root@fish ~]# ovs-appctl coverage/show 
Event coverage, avg rate over last: 5 seconds, last minute, last hour,  hash=f3e5372c:
nln_changed                0.0/sec     0.000/sec        0.0000/sec   total: 123
netlink_received          26.8/sec    26.083/sec       24.2886/sec   total: 11559962
netlink_recv_jumbo         0.0/sec     0.000/sec        0.0003/sec   total: 34
netlink_sent              25.6/sec    25.117/sec       23.5153/sec   total: 11153462
netdev_set_policing        0.0/sec     0.000/sec        0.0000/sec   total: 39
netdev_get_ifindex         0.0/sec     0.000/sec        0.0000/sec   total: 36
netdev_get_hwaddr          0.0/sec     0.000/sec        0.0000/sec   total: 36
netdev_set_hwaddr          0.0/sec     0.000/sec        0.0000/sec   total: 2
netdev_get_ethtool         0.0/sec     0.000/sec        0.0000/sec   total: 60
netdev_set_ethtool         0.0/sec     0.000/sec        0.0000/sec   total: 4
vconn_received             2.4/sec     2.400/sec        2.4822/sec   total: 726455
vconn_sent                 1.8/sec     1.800/sec        1.8617/sec   total: 544813
util_xalloc              1352.8/sec  1408.983/sec     1199.9022/sec   total: 556267078
unixctl_received           0.0/sec     0.033/sec        0.0006/sec   total: 11
</code></pre><h2 id="list-logging-levels">List logging levels</h2>
<pre><code>ovs-appctl vlog/list
</code></pre><h2 id="configure-debug-logging">Configure debug logging</h2>
<p>Syntax: vlog/set module[:facility[:level]]<br>Module: any valid module name displayed by list option.<br>Facility: must be one of the console, syslog, file<br>Level: must be one of the emer, err, warn, info, or dbg.  </p>
<p>Note: Special name &#x201C;ANY&#x201D; can be used to set the logging levels for all modules and facility.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./bash.html" class="navigation navigation-prev " aria-label="Previous page: bash"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./ovs_flow.html" class="navigation navigation-next " aria-label="Next page: ovs flow"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
